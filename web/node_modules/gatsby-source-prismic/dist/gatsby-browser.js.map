{"version":3,"file":"gatsby-browser.js","sources":["../src/common/constants.js","../src/common/utils.js","../src/common/validatePluginOptions.js","../src/browser/gatsby-browser.js"],"sourcesContent":["export const IS_BROWSER = typeof window !== 'undefined'\n\nexport const GLOBAL_STORE_KEY = '___PRISMIC___'\n\nexport const IMAGE_FIELD_KEYS = [\n  'dimensions',\n  'alt',\n  'copyright',\n  'url',\n  'localFile',\n]\n","export const isFunction = x => !!(x && x.constructor && x.call && x.apply)\n\n// See: lodash.pick\nexport const pick = fields => obj =>\n  Object.keys(obj).reduce((acc, key) => {\n    if (fields.includes(key)) acc[key] = obj[key]\n    return acc\n  }, {})\n\n// See: lodash.omit\nexport const omit = fields => obj =>\n  Object.keys(obj).reduce((acc, key) => {\n    if (!fields.includes(key)) acc[key] = obj[key]\n    return acc\n  }, {})\n\n// Maps an object to a new object with key-value pairs. Mapping function must\n// return a key-value tuple.\nexport const mapObj = fn => async obj => {\n  const entries = Object.entries(obj)\n  const pairs = await Promise.all(entries.map(x => Promise.resolve(fn(x))))\n\n  const result = {}\n\n  for (let i = 0; i < pairs.length; i++) {\n    const [k, v] = pairs[i]\n    result[k] = v\n  }\n\n  return result\n}\n","import {\n  array as yupArray,\n  mixed as yupMixed,\n  object as yupObject,\n  string as yupString,\n} from 'yup'\n\nimport { isFunction } from './utils'\n\nconst baseValidations = {\n  repositoryName: yupString()\n    .nullable()\n    .required(),\n  accessToken: yupString()\n    .nullable()\n    .required(),\n  linkResolver: yupMixed()\n    .test('is function', '${path} is not a function', isFunction)\n    .default(() => () => {}),\n  fetchLinks: yupArray()\n    .of(yupString().required())\n    .default([]),\n  htmlSerializer: yupMixed()\n    .test('is function', '${path} is not a function', isFunction)\n    .default(() => () => {}),\n  schemas: yupObject()\n    .nullable()\n    .required(),\n  lang: yupString()\n    .nullable()\n    .default('*'),\n  shouldNormalizeImage: yupMixed()\n    .test('is function', '${path} is not a function', isFunction)\n    .default(() => () => true),\n  plugins: yupArray()\n    .max(0)\n    .default([]),\n}\n\nexport const validatePluginOptions = (pluginOptions, requireSchemas = true) => {\n  const schema = yupObject().shape({\n    ...baseValidations,\n    schemas: requireSchemas ? baseValidations.schemas : undefined,\n    typePathsFilenamePrefix: yupString()\n      .nullable()\n      .default(`prismic-typepaths---${pluginOptions.repositoryName}-`),\n  })\n\n  return schema.validate(pluginOptions, { abortEarly: false })\n}\n","import md5 from 'md5'\nimport queryString from 'query-string'\n\nimport { IS_BROWSER, GLOBAL_STORE_KEY } from '../common/constants'\nimport { validatePluginOptions } from '../common/validatePluginOptions'\nimport { omit } from '../common/utils'\n\nexport const onClientEntry = async (_, rawPluginOptions) => {\n  if (!IS_BROWSER) return\n\n  const searchParams = queryString.parse(window.location.search)\n  const isPreviewSession = searchParams.token && searchParams.documentId\n\n  if (isPreviewSession) {\n    const pluginOptions = await validatePluginOptions(\n      omit(['schemas', 'plugins'])(rawPluginOptions),\n      false,\n    )\n    const schemasDigest = md5(JSON.stringify(rawPluginOptions.schemas))\n\n    window[GLOBAL_STORE_KEY] = window[GLOBAL_STORE_KEY] || {}\n\n    Object.assign(window[GLOBAL_STORE_KEY], {\n      [rawPluginOptions.repositoryName]: {\n        pluginOptions,\n        schemasDigest,\n      },\n    })\n  }\n}\n"],"names":["IS_BROWSER","window","GLOBAL_STORE_KEY","isFunction","x","constructor","call","apply","omit","fields","obj","Object","keys","reduce","acc","key","includes","baseValidations","repositoryName","yupString","nullable","required","accessToken","linkResolver","yupMixed","test","default","fetchLinks","yupArray","of","htmlSerializer","schemas","yupObject","lang","shouldNormalizeImage","plugins","max","validatePluginOptions","pluginOptions","requireSchemas","schema","shape","undefined","typePathsFilenamePrefix","validate","abortEarly","onClientEntry","_","rawPluginOptions","searchParams","queryString","parse","location","search","isPreviewSession","token","documentId","schemasDigest","md5","JSON","stringify","assign"],"mappings":"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"}