{"version":3,"file":"size-plugin.js","sources":["../src/util.mjs","../src/index.mjs"],"sourcesContent":["/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nexport function toMap(names, values) {\n\treturn names.reduce((map, name, i) => {\n\t\tmap[name] = values[i];\n\t\treturn map;\n\t}, {});\n}\n\nexport function dedupe(item, index, arr) {\n\treturn arr.indexOf(item) === index;\n}\n","/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport path from 'path';\nimport promisify from 'util.promisify';\nimport globPromise from 'glob';\nimport minimatch from 'minimatch';\nimport gzipSize from 'gzip-size';\nimport chalk from 'chalk';\nimport prettyBytes from 'pretty-bytes';\nimport escapeRegExp from 'escape-string-regexp';\nimport { toMap, dedupe } from './util.mjs';\n\nconst glob = promisify(globPromise);\n\nconst NAME = 'SizePlugin';\n\n/**\n * @typedef Item\n * @property {string} name Filename of the item\n * @property {number} sizeBefore Previous size, in kilobytes\n * @property {number} size Current size, in kilobytes\n * @property {string} sizeText Formatted current size\n * @property {number} delta Difference from previous size, in kilobytes\n * @property {string} deltaText Formatted size delta\n * @property {string} msg Full item's default message\n * @property {string} color The item's default CLI color\n */\n\n/**\n * @typedef Data\n * @property {Item[]} sizes List of file size items\n * @property {string} output Current buffered output\n */\n\n/**\n * Size Plugin for Webpack\n * @param {Object} options\n * @param {string} [options.pattern] minimatch pattern of files to track\n * @param {string} [options.exclude] minimatch pattern of files NOT to track\n * @param {function} [options.stripHash] custom function to remove/normalize hashed filenames for comparison\n * @param {(item:Item)=>string?} [options.decorateItem] custom function to decorate items\n * @param {(data:Data)=>string?} [options.decorateAfter] custom function to decorate all output\n */\nexport default class SizePlugin {\n\tconstructor (options) {\n\t\tthis.options = options || {};\n\t\tthis.pattern = this.options.pattern || '**/*.{mjs,js,css,html}';\n\t\tthis.exclude = this.options.exclude;\n\t}\n\n\treverseTemplate(filename, template) {\n\t\t// @todo - find a way to actually obtain values here.\n\t\tif (typeof template === 'function') {\n\t\t\ttemplate = template({\n\t\t\t\tchunk: {\n\t\t\t\t\tname: 'main'\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconst hashLength = this.output.hashDigestLength;\n\t\tconst replace = [];\n\t\tlet count = 0;\n\t\tfunction replacer() {\n\t\t\tlet out = '';\n\t\t\tfor (let i = 1; i < arguments.length - 2; i++) {\n\t\t\t\t// eslint-disable-next-line prefer-spread,prefer-rest-params\n\t\t\t\tlet value = arguments[i];\n\t\t\t\tif (replace[i - 1]) value = value.replace(/./g, '*');\n\t\t\t\tout += value;\n\t\t\t}\n\t\t\treturn out;\n\t\t}\n\t\tconst reg = template.replace(/(^|.+?)(?:\\[([a-z]+)(?::(\\d))?\\]|$)/g, (s, before, type, size) => {\n\t\t\tlet out = '';\n\t\t\tif (before) {\n\t\t\t\tout += `(${escapeRegExp(before)})`;\n\t\t\t\treplace[count++] = false;\n\t\t\t}\n\t\t\tif (type==='hash' || type==='contenthash' || type==='chunkhash') {\n\t\t\t\tconst len = Math.round(size) || hashLength;\n\t\t\t\tout += `([0-9a-zA-Z]{${len}})`;\n\t\t\t\treplace[count++] = true;\n\t\t\t}\n\t\t\telse if (type) {\n\t\t\t\tout += '(.*?)';\n\t\t\t\treplace[count++] = false;\n\t\t\t}\n\t\t\treturn out;\n\t\t});\n\t\tconst matcher = new RegExp(`^${reg}$`);\n\t\treturn matcher.test(filename) && filename.replace(matcher, replacer);\n\t}\n\n\tstripHash(filename) {\n\t\treturn (\n\t\t\tthis.options.stripHash && this.options.stripHash(filename) ||\n\t\t\tthis.reverseTemplate(filename, this.output.filename) ||\n\t\t\tthis.reverseTemplate(filename, this.output.chunkFilename) ||\n\t\t\tfilename\n\t\t);\n\t}\n\n\tasync apply(compiler) {\n\t\tconst outputPath = compiler.options.output.path;\n\t\tthis.output = compiler.options.output;\n\t\tthis.sizes = this.getSizes(outputPath);\n\t\tconst afterEmit = (compilation, callback) => {\n\t\t\tthis.outputSizes(compilation.assets).then(output => {\n\t\t\t\tif (output) {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\tconsole.log('\\n' + output);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}).catch(console.error).then(callback);\n\t\t};\n\n\t\t// for webpack version > 4\n\t\tif (compiler.hooks && compiler.hooks.emit) {\n\t\t\tcompiler.hooks.emit.tapAsync(NAME, afterEmit);\n\t\t}\n\t\telse {\n\t\t\t// for webpack version < 3\n\t\t\tcompiler.plugin('after-emit', afterEmit);\n\t\t}\n\t}\n\n\tasync outputSizes (assets) {\n\t\t// map of filenames to their previous size\n\t\t// Fix #7 - fast-async doesn't allow non-promise values.\n\t\tconst sizesBefore = await Promise.resolve(this.sizes);\n\t\tconst isMatched = minimatch.filter(this.pattern);\n\t\tconst isExcluded = this.exclude ? minimatch.filter(this.exclude) : () => false;\n\t\tconst assetNames = Object.keys(assets).filter(file => isMatched(file) && !isExcluded(file));\n\t\tconst sizes = await Promise.all(assetNames.map(name => gzipSize(assets[name].source())));\n\n\t\t// map of de-hashed filenames to their final size\n\t\tthis.sizes = toMap(assetNames.map(filename => this.stripHash(filename)), sizes);\n\n\t\t// get a list of unique filenames\n\t\tconst files = Object.keys(this.sizes).filter(dedupe);\n\n\t\tconst width = Math.max(...files.map(file => file.length));\n\t\tlet output = '';\n\t\tconst items = [];\n\t\tfor (const name of files) {\n\t\t\tconst size = this.sizes[name] || 0;\n\t\t\tconst sizeBefore = sizesBefore[name] || 0;\n\t\t\tconst delta = size - sizeBefore;\n\t\t\tconst msg = new Array(width - name.length + 2).join(' ') + name + ' â¤  ';\n\t\t\tconst color = size > 100 * 1024 ? 'red' : size > 40 * 1024 ? 'yellow' : size > 20 * 1024 ? 'cyan' : 'green';\n\t\t\tlet sizeText = chalk[color](prettyBytes(size));\n\t\t\tlet deltaText = '';\n\t\t\tif (delta && Math.abs(delta) > 1) {\n\t\t\t\tdeltaText = (delta > 0 ? '+' : '') + prettyBytes(delta);\n\t\t\t\tif (delta > 1024) {\n\t\t\t\t\tsizeText = chalk.bold(sizeText);\n\t\t\t\t\tdeltaText = chalk.red(deltaText);\n\t\t\t\t}\n\t\t\t\telse if (delta < -10) {\n\t\t\t\t\tdeltaText = chalk.green(deltaText);\n\t\t\t\t}\n\t\t\t\tsizeText += ` (${deltaText})`;\n\t\t\t}\n\t\t\tlet text = msg + sizeText + '\\n';\n\t\t\tconst item = { name, sizeBefore, size, sizeText, delta, deltaText, msg, color };\n\t\t\titems.push(item);\n\t\t\tif (this.options.decorateItem) {\n\t\t\t\ttext = this.options.decorateItem(text, item) || text;\n\t\t\t}\n\t\t\toutput += text;\n\t\t}\n\t\tif (this.options.decorateAfter) {\n\t\t\tconst opts = {\n\t\t\t\tsizes: items,\n\t\t\t\traw: { sizesBefore, sizes: this.sizes },\n\t\t\t\toutput\n\t\t\t};\n\t\t\tconst text = this.options.decorateAfter(opts);\n\t\t\tif (text) {\n\t\t\t\toutput += '\\n' + text.replace(/^\\n/g, '');\n\t\t\t}\n\t\t}\n\t\treturn output;\n\t}\n\n\tasync getSizes (cwd) {\n\t\tconst files = await glob(this.pattern, { cwd, ignore: this.exclude });\n\n\t\tconst sizes = await Promise.all(files.map(\n\t\t\tfile => gzipSize.file(path.join(cwd, file)).catch(() => null)\n\t\t));\n\n\t\treturn toMap(files.map(filename => this.stripHash(filename)), sizes);\n\t}\n}\n"],"names":["const","let","arguments","this","text"],"mappings":"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"}